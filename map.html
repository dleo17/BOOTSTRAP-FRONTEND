<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mein Lieblings-Ort â€“ Info Website 2025</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">

  <!-- Leaflet CSS (fÃ¼r Karte) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    /* Karte soll eine fixe HÃ¶he haben */
    #mapBox {
      width: 100%;
      height: 400px;
      border-radius: .5rem;
      background: #eef2f6;
      border: 1px solid rgba(0,0,0,.1);
      overflow: hidden;
    }

    /* kleiner Effekt beim Refresh */
    .ring {
      animation: pulse 0.4s ease;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(13,110,253,0.4); }
      100% { box-shadow: 0 0 0 15px rgba(13,110,253,0); }
    }
  </style>
</head>
<body data-page="map" class="bg-light">
  <div id="site-nav"></div>

  <main class="container my-4">
    <h1 class="display-6 fw-bold mb-4 text-center">Mein Lieblings-Ort</h1>

    <div class="text-center mb-3">
      <button id="btnMap" class="btn btn-primary pill-btn me-2">Karte anzeigen</button>
    </div>

    <!-- ðŸ” Eingabefeld fÃ¼r Orts-Suche -->
    <div class="input-group mb-4">
      <input type="text" id="placeInput" class="form-control" placeholder="Ort eingeben, z. B. ZÃ¼rich HB" />
      <button id="btnSearch" class="btn btn-outline-primary">Ort suchen</button>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div id="mapBox" class="d-flex align-items-center justify-content-center text-muted">
          Karte folgtâ€¦
        </div>
      </div>
    </div>
  </main>

  <!-- jQuery, Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Deine gemeinsame Logik (Nav usw.) -->
  <script src="app.js"></script>

  <script>
  // Fester Lieblingsort (BBW â€“ Pionierstrasse 28, Winterthur)
  const FAV_LAT = 47.498311992166585;
  const FAV_LON = 8.719900186507994;
  const FAV_LABEL = "Mein Lieblings-Ort: BBW Pionierstrasse 28, Winterthur ðŸ«";

  let mapInstance = null;
  let userMarker = null;

  // Funktion: Karte initialisieren
  function initMap() {
    const $mapBox = $('#mapBox');
    if (mapInstance) {
      $mapBox.addClass('ring').delay(300).queue(next => {
        $mapBox.removeClass('ring');
        next();
      });
      return;
    }

    $mapBox
      .removeClass('d-flex align-items-center justify-content-center text-muted')
      .text('')
      .append('<div id="leafletMap" style="width:100%;height:100%;"></div>');

    mapInstance = L.map('leafletMap').setView([FAV_LAT, FAV_LON], 16);

    const swissTopoLayer = L.tileLayer(
      'https://wmts10.geo.admin.ch/1.0.0/ch.swisstopo.pixelkarte-farbe/default/current/3857/{z}/{x}/{y}.jpeg',
      {
        attribution: 'Â© swisstopo | api3.geo.admin.ch',
        maxZoom: 19,
        minZoom: 0
      }
    ).addTo(mapInstance);

    const marker = L.marker([FAV_LAT, FAV_LON]).addTo(mapInstance);
    marker.bindPopup(`<strong>${FAV_LABEL}</strong><br>${FAV_LAT.toFixed(5)}, ${FAV_LON.toFixed(5)}`).openPopup();
  }

  // Button "Karte anzeigen"
  $('#btnMap').on('click', initMap);

  // Button "Ort suchen"
  $('#btnSearch').on('click', async function() {
    const query = $('#placeInput').val().trim();
    if (!query) {
      alert('Bitte gib einen Ort ein.');
      return;
    }

    // Falls Karte noch nicht initialisiert wurde â†’ initialisieren
    if (!mapInstance) initMap();

    try {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=1`;
      const response = await fetch(url);
      const data = await response.json();

      if (data.length === 0) {
        alert('Ort nicht gefunden ðŸ˜•');
        return;
      }

      const { lat, lon, display_name } = data[0];
      const coords = [parseFloat(lat), parseFloat(lon)];
      mapInstance.setView(coords, 15);

      // Falls schon ein Marker existiert â†’ entfernen
      if (userMarker) {
        mapInstance.removeLayer(userMarker);
      }

      userMarker = L.marker(coords).addTo(mapInstance);
      userMarker.bindPopup(`<strong>${display_name}</strong>`).openPopup();
    } catch (err) {
      console.error('Fehler bei Ortssuche:', err);
      alert('Fehler beim Laden des Ortes ðŸ˜¬');
    }
  });
  </script>
</body>
</html>